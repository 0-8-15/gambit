# makefile for Gambit-C system.

# Copyright (c) 1994-2008 by Marc Feeley, All Rights Reserved.

PACKAGE_SHORTNAME = @PACKAGE_SHORTNAME@
PACKAGE_NAME = @PACKAGE_NAME@
PACKAGE_VERSION = @PACKAGE_VERSION@
PACKAGE_STRING = @PACKAGE_STRING@
PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
PACKAGE_TARNAME = @PACKAGE_TARNAME@
PACKAGE_SUBDIR = @PACKAGE_SUBDIR@

@SET_MAKE@

srcdir = @srcdir@
VPATH = @srcdir@
srcdirpfx = @srcdirpfx@

C_COMPILER = @C_COMPILER@
C_PREPROC = @C_PREPROC@
FLAGS_OBJ = @FLAGS_OBJ@
FLAGS_DYN = @FLAGS_DYN@
FLAGS_LIB = @FLAGS_LIB@
FLAGS_EXE = @FLAGS_EXE@
DEFS = @DEFS@
LIBS = @LIBS@

GAMBCLIB = @GAMBCLIB@
GAMBCCOMPLIB = @GAMBCCOMPLIB@
INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
INSTALL_LIB = @INSTALL_LIB@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
LN_S = @LN_S@
RANLIB = @RANLIB@
HG = @HG@

prefix = @prefix@
exec_prefix = @exec_prefix@
includedir = $(prefix)$(PACKAGE_SUBDIR)/include
libdir = $(prefix)$(PACKAGE_SUBDIR)/lib
bindir = $(prefix)$(PACKAGE_SUBDIR)/bin
docdir = $(prefix)$(PACKAGE_SUBDIR)/doc
infodir = $(prefix)$(PACKAGE_SUBDIR)/info
emacsdir = $(prefix)$(PACKAGE_SUBDIR)/share/emacs/site-lisp

# This directory's subdirectories are mostly independent; you can cd
# into them and run `make' without going through this makefile.
# To change the values of `make' variables: instead of editing makefiles,
# (1) if the variable is set in `config.status', edit `config.status'
#     (which will cause the makefiles to be regenerated when you run `make');
# (2) otherwise, pass the desired values on the `make' command line.

MDEFINES = prefix=$(prefix) exec_prefix=$(exec_prefix) \
includedir=$(includedir) libdir=$(libdir) \
bindir=$(bindir) docdir=$(docdir) \
infodir=$(infodir) emacsdir=$(emacsdir)

SUBDIRS = include lib gsi gsc bin misc doc tests examples prebuilt

RCFILES = README INSTALL.txt LICENSE-2.0.txt LGPL.txt \
makefile.in configure configure.ac config.guess config.sub install-sh mkidirs

HGRCFILES = .hgignore .hgtags

GENDISTFILES =

DISTFILES = $(RCFILES) $(GENDISTFILES)

HGDISTFILES = $(HGRCFILES)

.SUFFIXES:

all: all-pre all-recursive all-post

all-pre:

all-post:

fake_target:

doc info pdf html txt: fake_target
	cd doc && $(MAKE) $(MDEFINES) $@

bootstrap: fake_target all
	cp gsc/gsc gsc-comp

check: fake_target all
	cd tests && $(MAKE) $(MDEFINES) $@

examples: fake_target all
	cd examples && $(MAKE) $(MDEFINES) $@

prebuilt: dist dist-devel
	cd prebuilt && $(MAKE) $(MDEFINES) $@

stamp: fake_target
	cd include && $(MAKE) $(MDEFINES) $@

commit: fake_target stamp
	$(HG) commit

update-nopull: fake_target
	next_version=`hg tags | sed -n -e '/$(PACKAGE_VERSION) /{g;1!p;};h' | sed -e 's/\([^ ]*\)-bootstrap.*/\1/'`; \
	next_version=`hg tags | sed -n -e '/$(PACKAGE_VERSION) /{g;1!p;};h' | grep -e 'v.*-bootstrap' | sed -e 's/\([^ ]*\)-bootstrap.*/\1/'`; \
	if test "$$next_version" = ""; then \
	  $(HG) update; \
	else \
	  $(HG) update -r $$next_version-bootstrap; \
	  $(MAKE) $(MDEFINES) bootstrap; \
	  $(HG) update -r $$next_version; \
	  $(MAKE) $(MDEFINES) clean bootstrap update; \
	fi

update: fake_target
	$(HG) pull
	$(MAKE) $(MDEFINES) update-nopull
	$(MAKE) $(MDEFINES)

new-major: fake_target
	major=`echo $(PACKAGE_VERSION) | sed -e"s&v\([^.]*\)\.\([^.]*\)\.\([^.]*\).*&\1&"`; \
	next_major=`eval expr 1 + $$major`; \
	next_version=v$$next_major.0.0; \
	$(MAKE) $(MDEFINES) NEW_VERSION=$$next_version change-version

new-minor: fake_target
	minor=`echo $(PACKAGE_VERSION) | sed -e"s&v\([^.]*\)\.\([^.]*\)\.\([^.]*\).*&\2&"`; \
	next_minor=`eval expr 1 + $$minor`; \
	next_version=`echo $(PACKAGE_VERSION) | sed -e"s&v\([^.]*\)\.\([^.]*\)\.\([^.]*\).*&v\1.$$next_minor.0&"`; \
	$(MAKE) $(MDEFINES) NEW_VERSION=$$next_version change-version

new-revision: fake_target
	revision=`echo $(PACKAGE_VERSION) | sed -e"s&v\([^.]*\)\.\([^.]*\)\.\([^.]*\).*&\3&"`; \
	next_revision=`eval expr 1 + $$revision`; \
	next_version=`echo $(PACKAGE_VERSION) | sed -e"s&v\([^.]*\)\.\([^.]*\)\.\([^.]*\).*&v\1.\2.$$next_revision&"`; \
	$(MAKE) $(MDEFINES) NEW_VERSION=$$next_version change-version

change-version: fake_target
	major=`echo $(PACKAGE_VERSION) | sed -e"s&v\([^.]*\)\.\([^.]*\)\.\([^.]*\).*&\1&"`; \
	minor=`echo $(PACKAGE_VERSION) | sed -e"s&v\([^.]*\)\.\([^.]*\)\.\([^.]*\).*&\2&"`; \
	revision=`echo $(PACKAGE_VERSION) | sed -e"s&v\([^.]*\)\.\([^.]*\)\.\([^.]*\).*&\3&"`; \
	next_major=`echo $(NEW_VERSION) | sed -e"s&v\([^.]*\)\.\([^.]*\)\.\([^.]*\).*&\1&"`; \
	next_minor=`echo $(NEW_VERSION) | sed -e"s&v\([^.]*\)\.\([^.]*\)\.\([^.]*\).*&\2&"`; \
	next_revision=`echo $(NEW_VERSION) | sed -e"s&v\([^.]*\)\.\([^.]*\)\.\([^.]*\).*&\3&"`; \
	version_num=`eval expr "\( 100000 \\* $$major \) + \( 1000 \\* $$minor \) + $$revision"`; \
	new_version_num=`eval expr "\( 100000 \\* $$next_major \) + \( 1000 \\* $$next_minor \) + $$next_revision"`; \
	sed -e "/(define (compiler-version) $$version_num)/s/$$version_num/$$new_version_num/" gsc/_parms.scm > gsc/_parms.scm-new; \
	if ! diff gsc/_parms.scm gsc/_parms.scm-new > /dev/null; then \
	  mv gsc/_parms.scm-new gsc/_parms.scm; \
	  $(HG) commit -m "[COMPILER CHANGES NEEDED FOR $(NEW_VERSION)] Changed version in compiler"; \
	  $(HG) tag $(NEW_VERSION)-bootstrap; \
	  if $(MAKE) $(MDEFINES) bootstrap; then \
	    misc/changev $$version_num $$new_version_num; \
	    cd tests; ../gsc/gsc -:=.. -f -c mix.scm; mv mix.c test5.ok; cd ..; \
	    if $(MAKE) $(MDEFINES) clean && $(MAKE) $(MDEFINES) -j 2 && $(MAKE) $(MDEFINES) check && $(MAKE) $(MDEFINES) doc; then \
	      $(HG) commit -m "[RUNTIME CHANGES NEEDED FOR $(NEW_VERSION)] Changed version of runtime using misc/changev"; \
	      $(HG) tag $(NEW_VERSION); \
	    fi; \
	  fi; \
	else \
	  echo Compiler version in gsc/_parms.scm is inconsistent with PACKAGE_VERSION; \
	fi

release: fake_target
	$(MAKE) $(MDEFINES) bootstrap
	$(MAKE) $(MDEFINES) mostlyclean
	$(MAKE) $(MDEFINES) all
	$(MAKE) $(MDEFINES) check
	$(MAKE) $(MDEFINES) doc
	rm -f $(PACKAGE_TARNAME).tgz $(PACKAGE_TARNAME)-*.*
	$(MAKE) $(MDEFINES) prebuilt

publish-release: fake_target
	misc/publish-release $(PACKAGE_VERSION) $(PACKAGE_TARNAME).tgz $(PACKAGE_TARNAME)-*.*

install-pre:

install-post: all
	rm -f $(prefix)/current $(prefix)/current.lnk
	if test "@bat@" = ""; then \
	  (cd $(prefix) && $(LN_S) .$(PACKAGE_SUBDIR) current); \
	fi

uninstall-pre:

uninstall-post:
	rm -f $(prefix)/current $(prefix)/current.lnk

mostlyclean-pre:

mostlyclean-post:

clean-pre: mostlyclean-pre

clean-post: mostlyclean-post

distclean-pre: clean-pre

distclean-post: clean-post
	rm -f makefile config.cache config.h config.log config.status

realclean-pre: distclean-pre

realclean-post: distclean-post

hg-setup-pre:
	$(HG) init
	$(HG) add $(RCFILES) $(HGRCFILES)
	rm -f .hg/hgrc
	echo "[paths]" > .hg/hgrc
	echo "default-push = ssh://gambit@trex.iro.umontreal.ca/HTML/repo/gambit" >> .hg/hgrc
	echo "default = http://www.iro.umontreal.ca/~gambit/repo/gambit/" >> .hg/hgrc

hg-setup-post:
	$(HG) commit --message "Initial commit of $(PACKAGE_STRING)"

dist-pre:
	rm -rf $(PACKAGE_TARNAME)
	mkdir $(PACKAGE_TARNAME)
	chmod 777 $(PACKAGE_TARNAME)
	@echo "  Copying distribution files:"
	@for file in $(DISTFILES); do \
	  echo "    $$file"; \
	  ln $(srcdirpfx)$$file $(PACKAGE_TARNAME) 2> /dev/null \
	    || cp -p $(srcdirpfx)$$file $(PACKAGE_TARNAME); \
	done

dist-post:
	tar chof $(PACKAGE_TARNAME).tar $(PACKAGE_TARNAME)
	gzip -9 $(PACKAGE_TARNAME).tar
	mv $(PACKAGE_TARNAME).tar.gz $(PACKAGE_TARNAME).tgz
	rm -rf $(PACKAGE_TARNAME)

dist-devel-pre:
	$(MAKE) $(MDEFINES) dist-pre
	@echo "  Copying distribution files:"
	@for file in $(HGDISTFILES); do \
	  echo "    $$file"; \
	  ln $(srcdirpfx)$$file $(PACKAGE_TARNAME) 2> /dev/null \
	    || cp -p $(srcdirpfx)$$file $(PACKAGE_TARNAME); \
	done
	@echo "    .hg"
	ln $(srcdirpfx).hg $(PACKAGE_TARNAME) 2> /dev/null \
	  || cp -p -R $(srcdirpfx).hg $(PACKAGE_TARNAME)

dist-devel-post:
	rm -rf $(PACKAGE_TARNAME)-devel
	mv $(PACKAGE_TARNAME) $(PACKAGE_TARNAME)-devel
	tar chof $(PACKAGE_TARNAME)-devel.tar $(PACKAGE_TARNAME)-devel
	gzip -9 $(PACKAGE_TARNAME)-devel.tar
	mv $(PACKAGE_TARNAME)-devel.tar.gz $(PACKAGE_TARNAME)-devel.tgz
	rm -rf $(PACKAGE_TARNAME)-devel

all-recursive install-recursive uninstall-recursive mostlyclean-recursive clean-recursive distclean-recursive realclean-recursive hg-setup-recursive dist-recursive dist-devel-recursive:
	@for subdir in $(SUBDIRS); do \
	  target=`echo $@ | sed 's/-recursive//'`; \
	  echo making $$target in $$subdir; \
	  (cd $$subdir && $(MAKE) $$target) || exit 1; \
	done

install: install-pre install-recursive install-post

uninstall: uninstall-pre uninstall-recursive uninstall-post

mostlyclean: mostlyclean-pre mostlyclean-recursive mostlyclean-post

clean: clean-pre clean-recursive clean-post

distclean: distclean-pre distclean-recursive distclean-post

realclean: realclean-pre realclean-recursive realclean-post

hg-setup: hg-setup-pre hg-setup-recursive hg-setup-post

dist: dist-pre dist-recursive dist-post

dist-devel: dist-devel-pre dist-devel-recursive dist-devel-post

# For an explanation of the following makefile rules, see node
# `Automatic Remaking' in GNU Autoconf documentation.

makefile: makefile.in config.status
	CONFIG_FILES=$@ CONFIG_HEADERS= ./config.status

config.status: configure
	./config.status --recheck

configure: configure.ac
	cd $(srcdir) && autoconf configure.ac > configure && chmod 755 configure

# Tell versions [3.59,3.63) of GNU make not to export all variables.
# Otherwise a system limit (for SysV at least) may be exceeded.
.NOEXPORT:
